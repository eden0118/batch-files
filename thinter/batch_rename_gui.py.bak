#!/usr/bin/env python3
"""
Batch File Renaming Tool - Simplified
Multilingual file batch renaming with live preview
"""

import os
from pathlib import Path
from typing import List, Optional
import tkinter as tk
from tkinter import filedialog, scrolledtext, messagebox

from styles import WINDOW_CONFIG, SPACING, FONTS, COLORS
from i18n import LANGUAGES, DEFAULT_LANGUAGE

try:
    from opencc import OpenCC
    OPENCC_AVAILABLE = True
except (ImportError, RuntimeError, Exception):
    OPENCC_AVAILABLE = False


class BatchRenameApp:
    """Main batch file renaming application"""

    def __init__(self, root: tk.Tk):
        self.root = root
        self.lang = LANGUAGES["en"]
        self.root.title(self.lang["app_title"])
        self.root.geometry(f"{WINDOW_CONFIG['width']}x{WINDOW_CONFIG['height']}")
        self.root.resizable(*WINDOW_CONFIG["resizable"])
        self.root.minsize(900, 600)

        # Initialize converter
        self.s2t_converter: Optional[OpenCC] = None
        if OPENCC_AVAILABLE:
            try:
                self.s2t_converter = OpenCC('s2t')
            except:
                pass

        # State variables
        self.selected_directory: Optional[Path] = None
        self.current_plan: List[tuple] = []
        self.rename_mode: str = "files"

        self.setup_ui()


    def setup_ui(self) -> None:
        """Setup UI Layout Architecture:
        ┌─────────────────────────────────────────────────────────┐
        │ ◇ BATCH RENAME              [Toggle Language Button]    │  Header
        ├──────────────────┬──────────────────────────────────────┤
        │  STEP 01-04      │                                      │
        │  Settings        │   ◇ LIVE_TERMINAL_FEED              │
        │                  │                                      │
        │  [PREVIEW        │   ┌──────────────────────────────┐  │
        │   OUTPUT]        │   │  Terminal Log (Scrollable)   │  │
        │                  │   └──────────────────────────────┘  │
        │                  │                                      │
        │                  │   STATUS: AWAITING EXECUTION        │
        │                  │   [Show Changes] [Confirm & Rename] │
        └──────────────────┴──────────────────────────────────────┘
        """
        # =====================================================================
        # Section 1: Header (Full Width)
        # =====================================================================
        # 高度: 自動 | 寬度: 100% | 外邊距: element_padx + (section_pady上 → 12px下)
        header = tk.Frame(self.root)
        header.pack(fill=tk.X, padx=SPACING["element_padx"], pady=(SPACING["section_pady"], 12))
        self.text_widgets["header"] = (header, "frame")

        title = tk.Label(header, text=self.lang["app_title"], font=self.theme["font_title"])
        title.pack(side=tk.LEFT, expand=True)
        self.text_widgets["title"] = (title, "label")

        # =====================================================================
        # Section 2: Main Container (Full Width, Responsive Height)
        # =====================================================================
        # 使用 Grid Layout 實現 50% : 50% 自適應分欄
        # 外邊距: element_padx (左右) + (0上 → section_pady下)
        # 注意: 為了支援最小尺寸限制，使用 pack 而非 Canvas
        #      視窗無法調整小於 900px，不需要水平卷軸
        main_container = tk.Frame(self.root, bg=self.theme["bg_primary"])
        main_container.pack(fill=tk.BOTH, expand=True, padx=SPACING["element_padx"],
                           pady=(0, SPACING["section_pady"]))

        # Grid 配置: 等權重列 (左右各 50%)
        # weight=1 表示列會平均分配可用空間
        main_container.grid_columnconfigure(0, weight=1)  # 左欄: 50% 寬度
        main_container.grid_columnconfigure(1, weight=1)  # 右欄: 50% 寬度
        main_container.grid_rowconfigure(0, weight=1)     # 行: 佔滿高度

        self.text_widgets["main_container"] = (main_container, "frame")
        # =====================================================================
        # Section 2A: Left Panel - Control Settings (50% Width)
        # =====================================================================
        # 配置: sticky="nsew" 讓 Frame 填滿整個 grid 格子
        #      padx 使用 SPACING["panel_padx_right"] (右邊距離 12px 分隔左右欄)
        left_panel = tk.Frame(main_container)
        left_panel.grid(row=0, column=0, sticky="nsew", padx=SPACING["panel_padx_right"])
        self.text_widgets["left_panel"] = (left_panel, "frame")

        # =====================================================================
        # Step 01: Choose Folder
        # =====================================================================
        # 類型: 水平佈局 (側邊排列)
        # 高度: 自動 | 寬度: 100% (填滿左欄)
        # 外邊距: 12px (內距)
        # 佈局: Pack 實現固定按鈕寬度 + 自適應標籤
        # 策略: 先 pack 按鈕 (右, 固定寬度) → 再 pack 標籤 (左, 填滿剩餘)
        step01 = self._create_step_frame("step_01", left_panel)

        # 先放置按鈕 (右邊，固定寬度)
        # side=tk.RIGHT: 靠右對齐 | width: BUTTON_STYLES["compact"]["width"]
        select_btn_config = get_widget_config(self.theme, "button").copy()
        select_btn_config.pop("font", None)  # Remove font to avoid duplicate
        self.select_btn = tk.Button(
            step01,
            text=self.lang["select_dir"],
            command=self.select_directory,
            font=self.theme["font_normal"],
            width=BUTTON_STYLES["compact"]["width"],
            **select_btn_config
        )
        self.select_btn.pack(side=tk.RIGHT, padx=(SPACING["button_padx_tight"], SPACING["widget_padx"]), pady=SPACING["button_pady"])
        self.text_widgets["select_btn"] = (self.select_btn, "button")

        # 再放置標籤 (左邊，填滿剩餘空間)
        # side=tk.LEFT: 靠左對齐 | fill=tk.X: 水平填滿 | expand=True: 擴展佔用剩餘空間
        self.dir_label = tk.Label(step01, text=self.lang["selected_dir"], font=self.theme["font_normal"])
        self.dir_label.pack(side=tk.LEFT, padx=SPACING["widget_padx"], pady=SPACING["widget_pady"], expand=True, fill=tk.X)
        self.text_widgets["dir_label"] = (self.dir_label, "label_secondary")

        # =====================================================================
        # Step 01B: Rename Mode Selection (Horizontal Layout)
        # =====================================================================
        # 類型: 獨立一行（在 Step 01 下方）- 選擇重新命名文件或文件+資料夾
        mode_frame = tk.Frame(left_panel)
        mode_frame.pack(fill=tk.X, padx=SPACING["element_padx"], pady=(0, SPACING["element_pady"]))
        self.text_widgets["mode_frame"] = (mode_frame, "frame")

        mode_label = tk.Label(mode_frame, text=self.lang["rename_mode"], font=self.theme["font_small"])
        mode_label.pack(side=tk.LEFT, padx=(0, SPACING["widget_padx"]))
        self.text_widgets["rename_mode"] = (mode_label, "label_secondary")

        self.mode_var = tk.StringVar(value="files")

        files_radio = tk.Radiobutton(mode_frame, text=self.lang["mode_files"], variable=self.mode_var,
                       value="files", command=self._on_mode_changed, font=self.theme["font_normal"])
        files_radio.pack(side=tk.LEFT, padx=SPACING["button_padx_tight"])
        self.text_widgets["mode_files"] = (files_radio, "radio")

        both_radio = tk.Radiobutton(mode_frame, text=self.lang["mode_both"], variable=self.mode_var,
                       value="both", command=self._on_mode_changed, font=self.theme["font_normal"])
        both_radio.pack(side=tk.LEFT, padx=SPACING["button_padx_tight"])
        self.text_widgets["mode_both"] = (both_radio, "radio")

        # =====================================================================
        # Step 02: File Filter
        # =====================================================================
        # 類型: 垂直佈局 (堆疊式)
        # 內容: RadioButton 選項 + Entry 文字框 + 提示文字
        # 間隔: RadioButton 間 3-6px | Entry 上 6px | 提示 3px
        step02 = self._create_step_frame("step_02", left_panel)

        self.filter_var = tk.StringVar(value="all")
        all_radio = tk.Radiobutton(step02, text=self.lang["all_files"], variable=self.filter_var,
                       value="all", command=self._on_filter_changed, font=self.theme["font_normal"])
        all_radio.pack(anchor=tk.W, padx=SPACING["widget_padx"], pady=SPACING["widget_pady_small"])
        self.text_widgets["all_radio"] = (all_radio, "radio")

        spec_radio = tk.Radiobutton(step02, text=self.lang["specific_type"], variable=self.filter_var,
                       value="specific", command=self._on_filter_changed, font=self.theme["font_normal"])
        spec_radio.pack(anchor=tk.W, padx=SPACING["widget_padx"], pady=SPACING["widget_pady_tiny"])
        self.text_widgets["spec_radio"] = (spec_radio, "radio")

        self.ext_entry = tk.Entry(step02, font=self.theme["font_normal"], state=tk.DISABLED)
        self.ext_entry.insert(0, self.lang["default_extensions"])
        self.ext_entry.pack(fill=tk.X, padx=SPACING["widget_padx_nested"], pady=(SPACING["widget_pady_small"], 0))
        self.text_widgets["ext_entry"] = (self.ext_entry, "entry")

        hint_label = tk.Label(step02, text=self.lang["example_ext"], font=self.theme["font_small"])
        hint_label.pack(anchor=tk.W, padx=SPACING["widget_padx_nested"], pady=SPACING["widget_pady_between"])
        self.text_widgets["hint_label"] = (hint_label, "label_secondary")

        # =====================================================================
        # Step 03: Operation
        # =====================================================================
        # 類型: 垂直佈局
        # 選項: Z2T (簡轉繁) / Replace (文字替換)
        # 條件式顯示: Replace 選項啟用時才顯示 From/To 輸入框
        step03 = self._create_step_frame("step_03", left_panel)

        self.operation_var = tk.StringVar(value="s2t")
        s2t_radio = tk.Radiobutton(step03, text=self.lang["s2t_convert"], variable=self.operation_var,
                       value="s2t", state=tk.NORMAL if OPENCC_AVAILABLE else tk.DISABLED,
                       font=self.theme["font_normal"], command=self._on_operation_changed)
        s2t_radio.pack(anchor=tk.W, padx=SPACING["widget_padx"], pady=SPACING["widget_pady_small"])
        self.text_widgets["s2t_radio"] = (s2t_radio, "radio")

        replace_radio = tk.Radiobutton(step03, text=self.lang["replace_text"], variable=self.operation_var,
                       value="replace", font=self.theme["font_normal"], command=self._on_operation_changed)
        replace_radio.pack(anchor=tk.W, padx=SPACING["widget_padx"], pady=SPACING["widget_pady_tiny"])
        self.text_widgets["replace_radio"] = (replace_radio, "radio")

        # Replace text inputs (initially hidden)
        replace_frame = tk.Frame(step03)
        replace_frame.pack(fill=tk.X, padx=SPACING["widget_padx_nested"], pady=SPACING["widget_pady_between"])
        self.text_widgets["replace_frame"] = (replace_frame, "frame")

        from_label = tk.Label(replace_frame, text=self.lang["replace_from"], font=self.theme["font_small"])
        from_label.pack(anchor=tk.W, pady=(0, SPACING["widget_pady_tiny"]))
        self.text_widgets["from_label"] = (from_label, "label_secondary")

        self.replace_from = tk.Entry(replace_frame, font=self.theme["font_normal"], state=tk.DISABLED)
        self.replace_from.pack(fill=tk.X, pady=SPACING["widget_pady_input_between"])
        self.text_widgets["replace_from"] = (self.replace_from, "entry")

        to_label = tk.Label(replace_frame, text=self.lang["replace_to"], font=self.theme["font_small"])
        to_label.pack(anchor=tk.W, pady=(0, SPACING["widget_pady_tiny"]))
        self.text_widgets["to_label"] = (to_label, "label_secondary")

        self.replace_to = tk.Entry(replace_frame, font=self.theme["font_normal"], state=tk.DISABLED)
        self.replace_to.pack(fill=tk.X)
        self.text_widgets["replace_to"] = (self.replace_to, "entry")

        self.replace_frame_ref = replace_frame

        # =====================================================================
        # Step 04: Format Settings
        # =====================================================================
        # 類型: 複合垂直佈局
        # 內容: 4 個格式選項 (移除符號、前綴、後綴、序號)
        # 間隔: 標籤 3px | 輸入框 8px | 複選框 12px
        # 最後: 格式預覽區域 (實時更新)
        step04 = self._create_step_frame("step_04", left_panel)

        remove_label = tk.Label(step04, text=self.lang["remove_symbols"], font=self.theme["font_small"])
        remove_label.pack(anchor=tk.W, padx=SPACING["widget_padx"], pady=(SPACING["widget_pady_small"], SPACING["widget_pady_tiny"]))
        self.text_widgets["remove_label"] = (remove_label, "label_secondary")

        self.symbols_entry = tk.Entry(step04, font=self.theme["font_normal"])
        self.symbols_entry.insert(0, self.lang["default_symbols"])
        self.symbols_entry.pack(fill=tk.X, padx=SPACING["widget_padx"], pady=SPACING["widget_pady_input_between"])
        self.text_widgets["symbols_entry"] = (self.symbols_entry, "entry")
        self.symbols_entry.bind("<KeyRelease>", lambda e: self._update_format_preview())

        prefix_label = tk.Label(step04, text=self.lang["add_prefix"], font=self.theme["font_small"])
        prefix_label.pack(anchor=tk.W, padx=SPACING["widget_padx"], pady=(0, SPACING["widget_pady_tiny"]))
        self.text_widgets["prefix_label"] = (prefix_label, "label_secondary")

        self.prefix_entry = tk.Entry(step04, font=self.theme["font_normal"])
        self.prefix_entry.pack(fill=tk.X, padx=SPACING["widget_padx"], pady=SPACING["widget_pady_input_between"])
        self.text_widgets["prefix_entry"] = (self.prefix_entry, "entry")
        self.prefix_entry.bind("<KeyRelease>", lambda e: self._update_format_preview())

        suffix_label = tk.Label(step04, text=self.lang["add_suffix"], font=self.theme["font_small"])
        suffix_label.pack(anchor=tk.W, padx=SPACING["widget_padx"], pady=(0, SPACING["widget_pady_tiny"]))
        self.text_widgets["suffix_label"] = (suffix_label, "label_secondary")

        self.suffix_entry = tk.Entry(step04, font=self.theme["font_normal"])
        self.suffix_entry.pack(fill=tk.X, padx=SPACING["widget_padx"], pady=SPACING["widget_pady_input_between"])
        self.text_widgets["suffix_entry"] = (self.suffix_entry, "entry")
        self.suffix_entry.bind("<KeyRelease>", lambda e: self._update_format_preview())

        # Format preview
        preview_label = tk.Label(step04, text=self.lang["preview_format"], font=self.theme["font_small"])
        preview_label.pack(anchor=tk.W, padx=SPACING["widget_padx"], pady=(0, SPACING["widget_pady_tiny"]))
        self.text_widgets["preview_label"] = (preview_label, "label_secondary")

        self.format_preview = tk.Label(step04, text=self.lang["format_preview"],
                                       font=self.theme["font_normal"], wraplength=400, justify=tk.LEFT)
        self.format_preview.pack(anchor=tk.W, padx=SPACING["widget_padx"], pady=SPACING["widget_pady_between"], fill=tk.X)
        self.text_widgets["format_preview"] = (self.format_preview, "label")

        # =====================================================================
        # Left Panel: Preview Output Section
        # =====================================================================
        # 類型: 展開式面板 (佔用左欄剩餘空間)
        # 高度: 自動擴展至佔滿左欄剩餘空間 (expand=True)
        # =====================================================================
        # Section 2B: Right Panel - Terminal Log (50% Width)
        # =====================================================================
        # 配置: sticky="nsew" 讓 Frame 填滿整個 grid 格子
        #      padx=0 (左邊無間距)
        right_panel = tk.Frame(main_container)
        right_panel.grid(row=0, column=1, sticky="nsew", padx=0)
        self.text_widgets["right_panel"] = (right_panel, "frame")

# =====================================================================
        # Right Panel: Terminal Header
        # =====================================================================
        # 高度: 自動 | 寬度: 100% (填滿右欄)
        # 外邊距: 0上 + 6px下 (分隔標題與日誌區域)
        term_header = tk.Frame(right_panel)
        term_header.pack(fill=tk.X, pady=(0, SPACING["section_padx_bottom"]))
        self.text_widgets["term_header"] = (term_header, "frame")

        term_title = tk.Label(term_header, text=self.lang["terminal_title"], font=self.theme["font_header"],
                             fg=self.theme["fg_primary"])
        term_title.pack(anchor=tk.W)
        self.text_widgets["terminal_title"] = (term_title, "label")

        # =====================================================================
        # Right Panel: Terminal Log Area with Green Border
        # =====================================================================
        # 邊框: solid, width=2px, color=green (#00DD00)
        # 外邊距: 0上 + 12px下 (分隔日誌與底部狀態欄)
        # 內邊距: 使用 SPACING["panel_padx_inner"] 和 SPACING["panel_pady_inner"]
        log_frame = tk.Frame(right_panel, relief=tk.SOLID, bd=2)
        log_frame.pack(fill=tk.BOTH, expand=True, pady=(0, SPACING["widget_pady"]))
        log_frame.configure(bg=self.theme["border"])
        self.text_widgets["log_frame"] = (log_frame, "frame")

        # 內層: 真正的日誌顯示區域 (黑色背景)
        log_inner = tk.Frame(log_frame, bg=self.theme["bg_primary"])
        log_inner.pack(fill=tk.BOTH, expand=True, padx=SPACING["panel_padx_inner"], pady=SPACING["panel_pady_inner"])
        self.text_widgets["log_inner"] = (log_inner, "frame")

        self.log_text = scrolledtext.ScrolledText(log_inner, font=self.theme["font_log"],
                                                  state=tk.DISABLED, wrap=tk.WORD)
        self.log_text.pack(fill=tk.BOTH, expand=True)
        self.text_widgets["log_text"] = (self.log_text, "text")

        # =====================================================================
        # Right Panel: Status and Action Buttons (Bottom Section)
        # =====================================================================
        # 分為兩列: 狀態指示器 (左) | 操作按鈕 (右)
        # 外邊距: 0上 (緊接日誌區) + 0下
        status_frame = tk.Frame(right_panel)
        status_frame.pack(fill=tk.X, pady=(0, 0))
        self.text_widgets["status_frame"] = (status_frame, "frame")

        # 狀態指示區 (左邊)
        # 格式: "STATUS" 標籤 + 實際狀態文字
        # 外邊距: 使用 SPACING["status_padx"] 和 SPACING["status_pady"]
        status_label = tk.Label(status_frame, text="STATUS", font=self.theme["font_small"],
                               fg=self.theme["fg_secondary"])
        status_label.pack(side=tk.LEFT, padx=SPACING["status_padx"], pady=SPACING["status_pady"])
        self.text_widgets["status_label"] = (status_label, "label")

        self.status_text = tk.Label(status_frame, text="AWAITING EXECUTION", font=self.theme["font_normal"],
                                    fg=self.theme["fg_primary"])
        self.status_text.pack(side=tk.LEFT, padx=0, pady=SPACING["status_pady"])
        self.text_widgets["status_text"] = (self.status_text, "label")

        # 按鈕區 (右邊)
        # 類型: 兩個按鈕並排 (Show Changes + Confirm & Rename)
        # 寬度: 各佔 50% (expand=True)
        # 間隔: 按鈕間使用 SPACING["button_group_padx"]
        button_frame = tk.Frame(right_panel)
        button_frame.pack(fill=tk.X, pady=(SPACING["button_pady"], 0))
        self.text_widgets["button_frame"] = (button_frame, "frame")

        preview_btn_config = get_widget_config(self.theme, "button_secondary").copy()
        preview_btn_config.pop("font", None)  # Remove font to avoid duplicate
        self.preview_btn = tk.Button(
            button_frame,
            text=self.lang["show_preview"],
            command=self.on_show_preview,
            font=self.theme["font_normal"],
            **preview_btn_config
        )
        self.preview_btn.pack(side=tk.LEFT, expand=True, padx=(0, SPACING["button_padx_tight"]))
        self.text_widgets["preview_btn"] = (self.preview_btn, "button_secondary")

        execute_btn_config = get_widget_config(self.theme, "button").copy()
        execute_btn_config.pop("font", None)  # Remove font to avoid duplicate
        self.execute_btn = tk.Button(
            button_frame,
            text=self.lang["confirm_rename"],
            command=self.on_confirm_execute,
            font=self.theme["font_header"],
            **execute_btn_config
        )
        self.execute_btn.pack(side=tk.LEFT, expand=True)
        self.text_widgets["execute_btn"] = (self.execute_btn, "button")

    def _create_step_frame(self, step_key: str, parent_frame: tk.Frame = None) -> tk.Frame:
        """Create a step frame with title"""
        if parent_frame is None:
            parent_frame = self.main_frame

        frame = tk.Frame(parent_frame)
        frame.pack(fill=tk.X, pady=(0, SPACING["element_pady"]))
        self.text_widgets[step_key] = (frame, "frame")

        title = tk.Label(frame, text=self.lang[step_key], font=self.theme["font_header"])
        title.pack(anchor=tk.W, padx=SPACING["label_title_padx"], pady=SPACING["label_title_pady"])
        self.text_widgets[f"{step_key}_title"] = (title, "label")

        return frame

    def _on_filter_changed(self) -> None:
        """Handle file filter change"""
        self.ext_entry.config(state=tk.NORMAL if self.filter_var.get() == "specific" else tk.DISABLED)

    def _on_mode_changed(self) -> None:
        """Handle rename mode change (files, folders, or both)"""
        self.rename_mode = self.mode_var.get()

    def _on_operation_changed(self) -> None:
        """Handle operation type change"""
        is_replace = self.operation_var.get() == "replace"
        self.replace_from.config(state=tk.NORMAL if is_replace else tk.DISABLED)
        self.replace_to.config(state=tk.NORMAL if is_replace else tk.DISABLED)

    def _update_format_preview(self) -> None:
        """Update format preview based on current settings"""
        if not self.selected_directory:
            preview_text = self.lang["format_preview"]
        else:
            try:
                all_items = list(self.selected_directory.glob("*"))[:3]
                if not all_items:
                    preview_text = self.lang["format_preview"]
                else:
                    lines = []
                    for item in all_items:
                        # 根據模式篩選要預覽的項目
                        if self.rename_mode == "files" and not item.is_file():
                            continue

                        preview = self._apply_format_to_filename(item.name, is_dir=item.is_dir())
                        lines.append(f"{item.name} → {preview}")
                    preview_text = "\n".join(lines) if lines else self.lang["format_preview"]
            except:
                preview_text = self.lang["format_preview"]

        self.format_preview.config(text=preview_text)

    def _apply_format_to_filename(self, filename: str, is_dir: bool = False) -> str:
        """Apply format settings to a filename for preview"""
        # 對於資料夾，使用完整名稱；對於檔案，分離 stem 和副檔名
        if is_dir:
            stem = filename
            ext = ""
        else:
            stem, ext = filename.rsplit(".", 1) if "." in filename else (filename, "")
            ext = f".{ext}" if ext else ""

        # Apply transformations
        if self.operation_var.get() == "s2t" and self.s2t_converter:
            stem = self.s2t_converter.convert(stem)

        symbols = self.symbols_entry.get()
        if symbols:
            for s in symbols:
                stem = stem.replace(s, "")

        prefix = self.prefix_entry.get().strip()
        if prefix:
            stem = prefix + stem

        suffix = self.suffix_entry.get().strip()
        if suffix:
            stem = stem + suffix

        return f"{stem}{ext}"

    def select_directory(self) -> None:
        """Select directory"""
        d = filedialog.askdirectory()
        if d:
            self.selected_directory = Path(d)
            self.dir_label.config(text=str(self.selected_directory), fg=self.theme["fg_primary"])
            self._update_format_preview()

    def log(self, msg: str) -> None:
        """Log message"""
        self.log_text.config(state=tk.NORMAL)
        self.log_text.insert(tk.END, msg + "\n")
        self.log_text.see(tk.END)
        self.log_text.config(state=tk.DISABLED)

    def update_status(self, status: str) -> None:
        """Update status display"""
        self.status_text.config(text=status)

    def _toggle_ext(self) -> None:
        """Toggle extension entry state (deprecated, use _on_filter_changed)"""
        self._on_filter_changed()

    # ============================================================================
    # 使用者互動 - 步驟 05：預覽
    # ============================================================================

    def on_show_preview(self) -> None:
        """Step 05: Show preview of changes"""
        self.current_plan = self._get_rename_plan()
        if not self.current_plan:
            return

        self._display_preview(self.current_plan)
        self.update_status("PREVIEW READY")

    def _display_preview(self, plan: List[tuple]) -> None:
        """Display preview of rename changes"""
        self.log_text.config(state=tk.NORMAL)
        self.log_text.delete(1.0, tk.END)
        self.log_text.config(state=tk.DISABLED)

        self.log("=" * 60)
        self.log(self.lang["log_started"])
        self.log(f"{self.lang['log_found_files'].format(len(plan))}\n")

        preview_lines = []
        for old_file, new_file in plan:
            log_msg = self.lang["log_success"].format(old_file.name, new_file.name)
            self.log(log_msg)
            preview_lines.append(f"{old_file.name}\n→ {new_file.name}")

        self.log("\n" + "=" * 60)
        self.log(self.lang["preview_mode"])

    # ============================================================================
    # 使用者互動 - 步驟 06：確認並執行
    # ============================================================================

    def on_confirm_execute(self) -> None:
        """Step 06: Confirm and execute rename"""
        if not self.current_plan:
            messagebox.showinfo(self.lang["info"], self.lang["no_changes"])
            return

        # Ask for confirmation
        count = len(self.current_plan)
        msg = self.lang["confirm_count"].format(count)

        if not messagebox.askyesno(self.lang["app_title"], msg):
            self.log("\n" + self.lang["execution_cancelled"])
            self.update_status("CANCELLED")
            return

        self.update_status("EXECUTING...")
        self._execute_plan(self.current_plan)

    # ============================================================================
    # 檔案重新命名流程 - 核心邏輯
    # ============================================================================

    def _get_rename_plan(self) -> Optional[List[tuple]]:
        """Generate file rename plan"""
        if not self.selected_directory:
            messagebox.showerror(self.lang["error"], self.lang["no_dir_selected"])
            return None

        # [步驟 1-1] 收集使用者設定
        operation = self.operation_var.get()
        symbols = self.symbols_entry.get()
        prefix = self.prefix_entry.get().strip()
        suffix = self.suffix_entry.get().strip()
        replace_from = self.replace_from.get().strip() if operation == "replace" else ""
        replace_to = self.replace_to.get().strip() if operation == "replace" else ""

        # [步驟 1-2] 取得檔案類型篩選條件
        exts = None
        if self.filter_var.get() == "specific":
            ext_str = self.ext_entry.get().strip()
            if not ext_str:
                messagebox.showerror(self.lang["error"], self.lang["no_extension"])
                return None
            exts = [e.strip() for e in ext_str.split(",") if e.strip()]

        # [步驟 1-3] 列出並篩選檔案/資料夾
        try:
            # 根據模式選擇要重命名的項目
            if self.rename_mode == "files":
                items = sorted(
                    [f for f in self.selected_directory.iterdir() if f.is_file()],
                    key=lambda x: x.name.lower()
                )
            else:  # both
                items = sorted(
                    [f for f in self.selected_directory.iterdir()],
                    key=lambda x: x.name.lower()
                )

            # 如果是檔案，應用副檔名篩選
            if self.rename_mode == "files" and exts:
                exts = [e.lower() if e.startswith('.') else f'.{e.lower()}' for e in exts]
                items = [f for f in items if f.is_file() and f.suffix.lower() in exts]
        except Exception as e:
            self.log(f"Error: {e}")
            return None

        if not items:
            messagebox.showinfo(self.lang["info"], self.lang["no_files"])
            return None

        # [步驟 1-4] 生成重命名計畫
        plan = []
        for i, f in enumerate(items, 1):
            try:
                # 對於檔案，分離 stem 和副檔名；對於資料夾，使用完整名稱
                if f.is_file():
                    stem = f.stem
                    ext = f.suffix
                else:
                    stem = f.name
                    ext = ""

                # 簡轉繁或替換文字
                if operation == "s2t" and self.s2t_converter:
                    stem = self.s2t_converter.convert(stem)
                elif operation == "replace" and replace_from:
                    stem = stem.replace(replace_from, replace_to)

                # 移除符號
                if symbols:
                    for s in symbols:
                        stem = stem.replace(s, "")

                # 添加前綴/後綴
                if prefix:
                    stem = prefix + stem
                if suffix:
                    stem = stem + suffix

                new_name = f"{stem}{ext}"
                new_path = f.parent / new_name

                if new_path != f and not new_path.exists():
                    plan.append((f, new_path))
            except Exception as e:
                self.log(self.lang["log_error"].format(str(e)))

        return plan

    # ============================================================================
    # 步驟 4：執行重命名
    # ============================================================================

    def _execute_plan(self, plan: List[tuple]) -> None:
        """Execute the rename plan"""
        # [步驟 4-1] 清空日誌並開始執行
        self.log_text.config(state=tk.NORMAL)
        self.log_text.delete(1.0, tk.END)
        self.log_text.config(state=tk.DISABLED)

        self.log("=" * 60)
        self.log(self.lang["log_started"])
        # 根據模式顯示不同的消息
        if self.rename_mode == "files":
            self.log(f"{self.lang['log_found_files'].format(len(plan))}\n")
        else:  # both
            self.log(f"找到 {len(plan)} 個項目\n")

        # [步驟 4-2] 逐一重命名檔案
        success = 0
        failed = 0

        for old_file, new_file in plan:
            try:
                old_file.rename(new_file)
                self.log(self.lang["log_success"].format(old_file.name, new_file.name))
                success += 1
            except Exception as e:
                self.log(self.lang["log_error"].format(str(e)))
                failed += 1

        # [步驟 4-3] 顯示執行結果摘要
        self.log(f"\n{self.lang['log_completed']}")
        self.log(f"{self.lang['log_success_count'].format(success)}")
        self.log(f"{self.lang['log_failed_count'].format(failed)}")
        self.update_status(f"COMPLETED: {success} SUCCESS, {failed} FAILED")
        messagebox.showinfo(self.lang["completed"], self.lang["completed_msg"].format(success, failed))


# ============================================================================
# 應用程式入口點
# ============================================================================

def main():
    root = tk.Tk()
    app = BatchRenameApp(root)
    root.mainloop()


if __name__ == "__main__":
    main()
